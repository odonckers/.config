# ----------------------------
# -- @title: TMUX           --
# -- @author: Owen Donckers --
# ----------------------------

set -g default-terminal "xterm-256color"

# -- Basic settings -----------------------------

# Enable ctrl + shift keys to work
%if #{||:#{m/ri:mintty|iTerm,#{TERM_PROGRAM}},#{!=:#{XTERM_VERSION},}}
set -g extended-keys on
%endif

# Enable mouse mode
set -g mouse on

# Faster command sequences
set -s escape-time 10

# Increase repeat timeout
set -sg repeat-time 600

# Enable focus events
set -s focus-events on

# -- Display ------------------------------------

set -g base-index 1
setw -g pane-base-index 1

setw -g automatic-rename on
set -g renumber-windows on

set -g set-titles on

# don't do anything when a 'bell' rings
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
setw -g monitor-activity off
set -g bell-action none

# -- TPM (plugins) ------------------------------

set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'tmux-plugins/tmux-sensible'

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-processes 'vi vim nvim emacs man less more tail top htop irssi weechat mutt opencode copilot'

set -g @plugin 'niksingh710/minimal-tmux-status'

# -- Theme --------------------------------------

set -g @C_NORM_BG "#1f1f1f"

set -g @C_YELLOW "#dcdcaa"
set -g @C_YELLOW_ORANGE "#d7ba7d"
set -g @C_CORNFLOWER_BLUE '#6796e6'

set -g @C_BLACK "#2d2d2d"

set -g @C_WARN_YELLOW "#cca700"

# -- Pane borders -------------------------------
set -g pane-border-style "fg=#{@C_BLACK}"
set -g pane-active-border-style "fg=#{@C_YELLOW_ORANGE}"

# -- Status position ----------------------------
set -g @minimal-tmux-status "bottom"
set -g @minimal-tmux-justify "left"

# -- Window status ------------------------------
set -g @minimal-tmux-bg "#{@C_YELLOW_ORANGE}"
set -g @minimal-tmux-fg "#{@C_BLACK}"
setw -g window-status-current-style "bold"

# -- Status arrows ------------------------------
set -g @minimal-tmux-right-arrow ""
set -g @minimal-tmux-left-arrow ""
set -g @minimal-tmux-use-arrow false

# -- Indicator ----------------------------------
set -g @minimal-tmux-indicator false
set -g @minimal-tmux-indicator-str "tmux "

# -- Status left --------------------------------
set -g status-left-length 50
set -g @minimal-tmux-left false
set -g @minimal-tmux-status-left " #S  "

# -- Status right -------------------------------
set -g status-right-length 50
set -g @minimal-tmux-right true
set -g @minimal-tmux-status-right "  #S "

# -- Messages -----------------------------------
set -g message-style "fg=white,bg=#{@C_BLACK}"
set -g message-command-style "fg=white,bg=#{@C_BLACK}"

# -- Copy mode ----------------------------------
setw -g mode-style "fg=#{@C_BLACK},bg=#{@C_CORNFLOWER_BLUE}"

# -- Keys ---------------------------------------

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?\.?(view|n?vim?x?)(-wrapped)?(diff)?$'"

# Reload config
bind r run "sh -c '\"\$TMUX_PROGRAM\" \${TMUX_SOCKET:+-S \"\$TMUX_SOCKET\"} source \"\$TMUX_CONF\"'" \; display "#{TMUX_CONF} sourced"

# Create session
bind C-c new-session

# Find session
bind C-f command-prompt -p find-session 'switch-client -t %%'

# Session navigation
bind BTab switch-client -l

# Split window
bind - split-window -v
bind _ split-window -h

# Navigate panes
bind -r h select-pane -L  # move left
bind -r j select-pane -D  # move down
bind -r k select-pane -U  # move up
bind -r l select-pane -R  # move right

bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' { if -F '#{pane_at_left}'   '' 'select-pane -L' }
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' { if -F '#{pane_at_bottom}' '' 'select-pane -D' }
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' { if -F '#{pane_at_top}'    '' 'select-pane -U' }
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' { if -F '#{pane_at_right}'  '' 'select-pane -R' }

bind-key -T copy-mode-vi 'C-h' if -F '#{pane_at_left}'   '' 'select-pane -L'
bind-key -T copy-mode-vi 'C-j' if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind-key -T copy-mode-vi 'C-k' if -F '#{pane_at_top}'    '' 'select-pane -U'
bind-key -T copy-mode-vi 'C-l' if -F '#{pane_at_right}'  '' 'select-pane -R'

# Swap panes
bind > swap-pane -D  # swap current pane with the next one
bind < swap-pane -U  # swap current pane with the previous one

bind -n 'C-S-left'  if-shell "$is_vim" 'send-keys C-S-left'  'swap-pane -s "{left-of}"'
bind -n 'C-S-down'  if-shell "$is_vim" 'send-keys C-S-down'  'swap-pane -s "{down-of}"'
bind -n 'C-S-up'    if-shell "$is_vim" 'send-keys C-S-up'    'swap-pane -s "{up-of}"'
bind -n 'C-S-right' if-shell "$is_vim" 'send-keys C-S-right' 'swap-pane -s "{right-of}"'

bind-key -T copy-mode-vi 'C-S-left'  swap-pane -s "{left-of}"
bind-key -T copy-mode-vi 'C-S-down'  swap-pane -s "{down-of}"
bind-key -T copy-mode-vi 'C-S-up'    swap-pane -s "{up-of}"
bind-key -T copy-mode-vi 'C-S-right' swap-pane -s "{right-of}"

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

bind -n 'C-left'  if-shell "$is_vim" 'send-keys C-left'  'resize-pane -L 5'
bind -n 'C-down'  if-shell "$is_vim" 'send-keys C-down'  'resize-pane -D 5'
bind -n 'C-up'    if-shell "$is_vim" 'send-keys C-up'    'resize-pane -U 5'
bind -n 'C-right' if-shell "$is_vim" 'send-keys C-right' 'resize-pane -R 5'

bind-key -T copy-mode-vi C-left  resize-pane -L 5
bind-key -T copy-mode-vi C-down  resize-pane -D 5
bind-key -T copy-mode-vi C-up    resize-pane -U 5
bind-key -T copy-mode-vi C-right resize-pane -R 5

# Navigate windows
bind -r C-h previous-window
bind -r C-l next-window
bind Tab last-window

# Swap windows
bind -r C-S-H swap-window -t -1 \; select-window -t -1
bind -r C-S-L swap-window -t +1 \; select-window -t +1

# Toggle mouse mode
bind m run "cut -c3- '#{TMUX_CONF}' | sh -s _toggle_mouse"

# Copy mode
bind Enter copy-mode # enter copy mode

bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel
bind -T copy-mode-vi H send -X start-of-line
bind -T copy-mode-vi L send -X end-of-line

%if #{==:#{TMUX_PROGRAM},}
  run "exec sh -c 'TMUX_PROGRAM=\"\$(LSOF=\$(PATH=\"\$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin\" command -v lsof); \$LSOF -b -w -a -d txt -p #{pid} -Fn 2>/dev/null | perl -n -e \"if (s/^n((?:.(?!dylib\$|so\$))+)\$/\\1/g && s/(?:\s+\\([^\\s]+?\\))?\$//g) { print; exit } } exit 1; {\" 2>/dev/null || readlink \"/proc/#{pid}/exe\" 2>/dev/null)\"; [ \"\$(\"\$TMUX_PROGRAM\" display -p \"#{l:#{pid}}\" 2>/dev/null)\" = \"#{pid}\" ] || TMUX_PROGRAM=\"\$(command -v tmux || printf tmux)\"; \"\$TMUX_PROGRAM\" -S #{socket_path} set-environment -g TMUX_PROGRAM \"\$TMUX_PROGRAM\"'"
%endif
%if #{==:#{TMUX_SOCKET},}
  run "exec sh -c '\"\$TMUX_PROGRAM\" -S #{socket_path} set-environment -g TMUX_SOCKET \"#{socket_path}\"'"
%endif
%if #{==:#{TMUX_CONF},}
  run "exec sh -c '\"\$TMUX_PROGRAM\" set-environment -g TMUX_CONF \$(for conf in \"\$HOME/.tmux.conf\" \"\$XDG_CONFIG_HOME/tmux/tmux.conf\" \"\$HOME/.config/tmux/tmux.conf\"; do [ -f \"\$conf\" ] && printf \"%s\" \"\$conf\" && break; done)'"
%endif

# Install TPM if it is not already installed
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
